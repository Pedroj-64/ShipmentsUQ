<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ruta de Entrega | ShipmentsUQ</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        .info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-width: 350px;
        }

        .info-panel h2 {
            font-size: 20px;
            margin-bottom: 15px;
            color: #1f2937;
            border-bottom: 2px solid #f59e0b;
            padding-bottom: 10px;
        }

        .info-item {
            margin-bottom: 12px;
            display: flex;
            align-items: start;
            gap: 10px;
        }

        .info-label {
            font-weight: 600;
            color: #6b7280;
            min-width: 80px;
        }

        .info-value {
            color: #1f2937;
        }

        .route-stats {
            background: #fef3c7;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
        }

        .route-stats h3 {
            font-size: 16px;
            margin-bottom: 10px;
            color: #92400e;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 2000;
            background: white;
            padding: 30px 50px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        .loading.hidden {
            display: none;
        }

        .spinner {
            border: 4px solid #f3f4f6;
            border-top: 4px solid #f59e0b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Calculando ruta √≥ptima...</p>
    </div>

    <div id="map"></div>

    <div class="info-panel">
        <h2>üöö Detalles de la Ruta</h2>
        <div class="info-item">
            <span class="info-label">üì¶ Env√≠o:</span>
            <span class="info-value" id="shipment-id">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">üë§ Cliente:</span>
            <span class="info-value" id="customer-name">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">üìç Origen:</span>
            <span class="info-value" id="origin-address">-</span>
        </div>
        <div class="info-item">
            <span class="info-label">üéØ Destino:</span>
            <span class="info-value" id="destination-address">-</span>
        </div>
        
        <div class="route-stats">
            <h3>üìä Estad√≠sticas de Ruta</h3>
            <div class="stat-item">
                <span>Distancia:</span>
                <strong id="route-distance">-</strong>
            </div>
            <div class="stat-item">
                <span>Tiempo estimado:</span>
                <strong id="route-time">-</strong>
            </div>
            <div class="stat-item">
                <span>Nodos en ruta:</span>
                <strong id="route-nodes">-</strong>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // ========================
        // ALGORITMO DE DIJKSTRA
        // ========================

        class Graph {
            constructor() {
                this.nodes = new Map();
                this.edges = new Map();
            }

            addNode(id, lat, lng, name = '') {
                this.nodes.set(id, { id, lat, lng, name });
            }

            addEdge(from, to, weight) {
                if (!this.edges.has(from)) {
                    this.edges.set(from, []);
                }
                this.edges.get(from).push({ to, weight });
                
                // Agregar edge bidireccional
                if (!this.edges.has(to)) {
                    this.edges.set(to, []);
                }
                this.edges.get(to).push({ to: from, weight });
            }

            dijkstra(startId, endId) {
                const distances = new Map();
                const previous = new Map();
                const unvisited = new Set(this.nodes.keys());

                // Inicializar distancias
                this.nodes.forEach((_, nodeId) => {
                    distances.set(nodeId, nodeId === startId ? 0 : Infinity);
                    previous.set(nodeId, null);
                });

                while (unvisited.size > 0) {
                    // Encontrar nodo no visitado con menor distancia
                    let currentNode = null;
                    let minDistance = Infinity;
                    
                    for (const nodeId of unvisited) {
                        const dist = distances.get(nodeId);
                        if (dist < minDistance) {
                            minDistance = dist;
                            currentNode = nodeId;
                        }
                    }

                    if (currentNode === null || minDistance === Infinity) break;
                    if (currentNode === endId) break;

                    unvisited.delete(currentNode);

                    // Actualizar distancias de vecinos
                    const neighbors = this.edges.get(currentNode) || [];
                    for (const { to, weight } of neighbors) {
                        if (!unvisited.has(to)) continue;

                        const newDist = distances.get(currentNode) + weight;
                        if (newDist < distances.get(to)) {
                            distances.set(to, newDist);
                            previous.set(to, currentNode);
                        }
                    }
                }

                // Reconstruir ruta
                const path = [];
                let current = endId;
                
                while (current !== null) {
                    path.unshift(current);
                    current = previous.get(current);
                }

                return {
                    path,
                    distance: distances.get(endId),
                    found: distances.get(endId) !== Infinity
                };
            }
        }

        // ========================
        // CREAR GRAFO DE ARMENIA
        // ========================

        function createArmeniaGraph() {
            const graph = new Graph();

            // Nodos principales de Armenia con coordenadas GPS reales
            graph.addNode('centro', 4.533889, -75.681111, 'Centro');
            graph.addNode('norte', 4.550000, -75.670000, 'Zona Norte');
            graph.addNode('sur', 4.520000, -75.690000, 'Zona Sur');
            graph.addNode('este', 4.540000, -75.665000, 'Zona Este');
            graph.addNode('oeste', 4.530000, -75.700000, 'Zona Oeste');
            graph.addNode('circunvalar', 4.545000, -75.685000, 'Av. Circunvalar');
            graph.addNode('bolivar', 4.535000, -75.675000, 'Av. Bol√≠var');
            graph.addNode('centenario', 4.525000, -75.680000, 'Av. Centenario');
            graph.addNode('la_14', 4.530000, -75.685000, 'La 14');
            graph.addNode('portal', 4.548000, -75.678000, 'Portal del Quind√≠o');
            graph.addNode('unicentro', 4.542000, -75.672000, 'Unicentro');
            graph.addNode('fundadores', 4.537000, -75.677000, 'Fundadores');
            graph.addNode('san_jose', 4.528000, -75.695000, 'San Jos√©');

            // Conexiones con distancias (en km)
            graph.addEdge('centro', 'norte', 2.5);
            graph.addEdge('centro', 'sur', 2.3);
            graph.addEdge('centro', 'este', 2.0);
            graph.addEdge('centro', 'oeste', 2.2);
            graph.addEdge('centro', 'bolivar', 0.8);
            graph.addEdge('centro', 'la_14', 1.0);
            graph.addEdge('norte', 'este', 1.5);
            graph.addEdge('norte', 'circunvalar', 1.2);
            graph.addEdge('norte', 'portal', 0.9);
            graph.addEdge('norte', 'unicentro', 1.3);
            graph.addEdge('sur', 'oeste', 1.8);
            graph.addEdge('sur', 'centenario', 1.0);
            graph.addEdge('sur', 'san_jose', 1.2);
            graph.addEdge('este', 'bolivar', 1.1);
            graph.addEdge('este', 'unicentro', 0.7);
            graph.addEdge('oeste', 'la_14', 1.4);
            graph.addEdge('oeste', 'san_jose', 0.9);
            graph.addEdge('circunvalar', 'bolivar', 1.3);
            graph.addEdge('circunvalar', 'portal', 1.0);
            graph.addEdge('bolivar', 'fundadores', 0.6);
            graph.addEdge('bolivar', 'unicentro', 0.8);
            graph.addEdge('centenario', 'la_14', 0.7);
            graph.addEdge('la_14', 'fundadores', 0.9);
            graph.addEdge('fundadores', 'unicentro', 0.8);

            return graph;
        }

        // ========================
        // FUNCIONES AUXILIARES
        // ========================

        function getClosestNode(graph, lat, lng) {
            let closestNode = null;
            let minDistance = Infinity;

            graph.nodes.forEach((node, nodeId) => {
                const dist = calculateDistance(lat, lng, node.lat, node.lng);
                if (dist < minDistance) {
                    minDistance = dist;
                    closestNode = nodeId;
                }
            });

            return closestNode;
        }

        function calculateDistance(lat1, lng1, lat2, lng2) {
            const R = 6371; // Radio de la Tierra en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng / 2) * Math.sin(dLng / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        // ========================
        // INICIALIZACI√ìN
        // ========================

        let map;
        const graph = createArmeniaGraph();

        // Obtener datos - primero intentar desde window.ROUTE_DATA (inyectado), luego desde URL
        let shipmentId, customer, delivererName, delivererLat, delivererLng, originLat, originLng, originAddr, destLat, destLng, destAddr;
        
        if (window.ROUTE_DATA) {
            // Datos inyectados directamente en el HTML
            console.log('üìã Datos recibidos desde window.ROUTE_DATA (inyectados)');
            shipmentId = window.ROUTE_DATA.shipmentId;
            customer = window.ROUTE_DATA.customer;
            delivererName = window.ROUTE_DATA.delivererName;
            delivererLat = window.ROUTE_DATA.delivererLat;
            delivererLng = window.ROUTE_DATA.delivererLng;
            originLat = window.ROUTE_DATA.originLat;
            originLng = window.ROUTE_DATA.originLng;
            originAddr = window.ROUTE_DATA.originAddr;
            destLat = window.ROUTE_DATA.destLat;
            destLng = window.ROUTE_DATA.destLng;
            destAddr = window.ROUTE_DATA.destAddr;
        } else {
            // Fallback: leer desde URL parameters
            console.log('üìã Datos recibidos desde URL parameters');
            const params = new URLSearchParams(window.location.search);
            shipmentId = params.get('id') || 'N/A';
            customer = params.get('customer') || 'Cliente';
            delivererName = params.get('delivererName') || 'Repartidor';
            delivererLat = parseFloat(params.get('delivererLat')) || 4.533889;
            delivererLng = parseFloat(params.get('delivererLng')) || -75.681111;
            originLat = parseFloat(params.get('originLat')) || 4.540000;
            originLng = parseFloat(params.get('originLng')) || -75.670000;
            originAddr = params.get('originAddr') || 'Direcci√≥n de origen';
            destLat = parseFloat(params.get('destLat')) || 4.520000;
            destLng = parseFloat(params.get('destLng')) || -75.690000;
            destAddr = params.get('destAddr') || 'Direcci√≥n de destino';
        }

        console.log('üì¶ Datos procesados:');
        console.log('  - Env√≠o:', shipmentId);
        console.log('  - Cliente:', customer);
        console.log('  - Repartidor:', delivererName, '‚Üí', delivererLat, delivererLng);
        console.log('  - Origen GPS:', originLat, originLng);
        console.log('  - Destino GPS:', destLat, destLng);

        // Actualizar panel de informaci√≥n
        document.getElementById('shipment-id').textContent = shipmentId;
        document.getElementById('customer-name').textContent = customer;
        document.getElementById('origin-address').textContent = originAddr;
        document.getElementById('destination-address').textContent = destAddr;

        // Inicializar mapa
        document.addEventListener('DOMContentLoaded', function() {
            map = L.map('map').setView([4.533889, -75.681111], 13);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);

            // Calcular y mostrar ruta
            calculateAndDisplayRoute();
        });

        function drawDirectRoutes() {
            console.log('üìç Dibujando rutas directas (instant√°neo)...');
            
            // Segmento 1: Repartidor ‚Üí Origen (azul punteado)
            L.polyline([
                [delivererLat, delivererLng],
                [originLat, originLng]
            ], {
                color: '#3b82f6',
                weight: 5,
                opacity: 0.7,
                dashArray: '10, 5'
            }).addTo(map).bindPopup('<b>Segmento 1:</b> Ir a recoger');
            
            // Segmento 2: Origen ‚Üí Destino (naranja s√≥lido)
            L.polyline([
                [originLat, originLng],
                [destLat, destLng]
            ], {
                color: '#f59e0b',
                weight: 6,
                opacity: 0.8
            }).addTo(map).bindPopup('<b>Segmento 2:</b> Entregar');
            
            // Marcadores
            drawMarkers();
            
            // Calcular distancias con f√≥rmula de Haversine
            const dist1 = calculateDistance(delivererLat, delivererLng, originLat, originLng);
            const dist2 = calculateDistance(originLat, originLng, destLat, destLng);
            const totalDist = dist1 + dist2;
            
            document.getElementById('route-distance').textContent = totalDist.toFixed(2) + ' km';
            document.getElementById('route-time').textContent = Math.ceil(totalDist * 3) + ' min';
            document.getElementById('route-nodes').textContent = '4 puntos';
            
            // Ajustar vista
            map.fitBounds([
                [delivererLat, delivererLng],
                [originLat, originLng],
                [destLat, destLng]
            ], { padding: [80, 80] });
            
            // Ocultar loading INMEDIATAMENTE
            document.getElementById('loading').classList.add('hidden');
            
            console.log('‚úÖ Rutas directas dibujadas (instant√°neo)');
        }
        
        function drawMarkers() {
            // Repartidor
            L.marker([delivererLat, delivererLng], {
                icon: L.divIcon({
                    className: 'deliverer-marker',
                    html: '<div style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">üö¥</div>',
                    iconSize: [40, 40]
                })
            }).addTo(map).bindPopup('<b>Repartidor</b><br>' + delivererName);

            // Origen
            L.marker([originLat, originLng], {
                icon: L.divIcon({
                    className: 'origin-marker',
                    html: '<div style="background: #10b981; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">üìç</div>',
                    iconSize: [35, 35]
                })
            }).addTo(map).bindPopup('<b>Origen</b><br>' + originAddr);

            // Destino
            L.marker([destLat, destLng], {
                icon: L.divIcon({
                    className: 'dest-marker',
                    html: '<div style="background: #ef4444; color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 18px; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.2);">üéØ</div>',
                    iconSize: [35, 35]
                })
            }).addTo(map).bindPopup('<b>Destino</b><br>' + destAddr);
        }

        function calculateAndDisplayRoute() {
            console.log('üöÄ Iniciando c√°lculo de ruta...');
            
            // PASO 1: Mostrar ruta directa INMEDIATAMENTE (sin esperar nada)
            drawDirectRoutes();
            
            // PASO 2: Intentar mejorar con OSRM en segundo plano (no bloquear UI)
            setTimeout(() => {
                tryOSRMEnhancement();
            }, 100); // 100ms despu√©s para no bloquear el render inicial
        }
        
        async function tryOSRMEnhancement() {
            console.log('üåê Intentando mejorar ruta con OSRM (en segundo plano)...');
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => {
                console.log('‚è±Ô∏è OSRM timeout (1s) - manteniendo ruta directa');
                controller.abort();
            }, 1000); // Solo 1 segundo de espera
            
            try {
                // Solicitud simplificada a OSRM
                const osrmUrl = `https://router.project-osrm.org/route/v1/driving/${delivererLng},${delivererLat};${originLng},${originLat};${destLng},${destLat}?overview=simplified&geometries=geojson`;
                
                const response = await fetch(osrmUrl, { signal: controller.signal });
                clearTimeout(timeoutId);
                
                if (!response.ok) throw new Error(`HTTP ${response.status}`);
                
                const data = await response.json();
                if (!data.routes || data.routes.length === 0) throw new Error('Sin rutas');
                
                const route = data.routes[0];
                console.log('‚úÖ OSRM respondi√≥ - mejorando visualizaci√≥n');
                
                // Obtener coordenadas (viene como [lng, lat], convertir a [lat, lng])
                const fullRouteCoords = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                
                // Separar en dos segmentos basado en los legs
                const legs = route.legs || [];
                let segment1Coords = [];
                let segment2Coords = [];
                
                if (legs.length >= 2) {
                    const leg1Distance = legs[0].distance || 0;
                    const leg2Distance = legs[1].distance || 0;
                    const totalDistance = leg1Distance + leg2Distance;
                    
                    if (totalDistance > 0) {
                        const splitRatio = leg1Distance / totalDistance;
                        const splitIndex = Math.round(fullRouteCoords.length * splitRatio);
                        
                        segment1Coords = fullRouteCoords.slice(0, splitIndex + 1);
                        segment2Coords = fullRouteCoords.slice(splitIndex);
                    } else {
                        segment1Coords = fullRouteCoords;
                    }
                } else {
                    segment1Coords = fullRouteCoords;
                }
                
                // Limpiar mapa y redibujar con rutas OSRM
                map.eachLayer(layer => {
                    if (layer instanceof L.Polyline || layer instanceof L.Marker) {
                        map.removeLayer(layer);
                    }
                });
                
                // Re-agregar tile layer
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);
                
                // Dibujar segmento 1 (Repartidor ‚Üí Origen) con OSRM
                if (segment1Coords.length > 0) {
                    L.polyline(segment1Coords, {
                        color: '#3b82f6',
                        weight: 5,
                        opacity: 0.8,
                        lineJoin: 'round',
                        lineCap: 'round',
                        dashArray: '10, 5'
                    }).addTo(map).bindPopup('<b>Ruta real:</b> Ir a recoger');
                }
                
                // Dibujar segmento 2 (Origen ‚Üí Destino) con OSRM
                if (segment2Coords.length > 0) {
                    L.polyline(segment2Coords, {
                        color: '#f59e0b',
                        weight: 6,
                        opacity: 0.9,
                        lineJoin: 'round',
                        lineCap: 'round'
                    }).addTo(map).bindPopup('<b>Ruta real:</b> Entregar');
                }
                
                // Re-dibujar marcadores
                drawMarkers();
                
                // Actualizar estad√≠sticas con datos reales
                const distanceKm = (route.distance / 1000).toFixed(2);
                const timeMinutes = Math.ceil(route.duration / 60);
                const allCoords = segment2Coords.length > 0 ? [...segment1Coords, ...segment2Coords] : fullRouteCoords;
                
                document.getElementById('route-distance').textContent = distanceKm + ' km (real)';
                document.getElementById('route-time').textContent = timeMinutes + ' min (real)';
                document.getElementById('route-nodes').textContent = allCoords.length + ' puntos';
                
                // Ajustar vista
                const bounds = L.latLngBounds(allCoords);
                bounds.extend([delivererLat, delivererLng]);
                bounds.extend([originLat, originLng]);
                bounds.extend([destLat, destLng]);
                map.fitBounds(bounds, { padding: [80, 80] });
                
                console.log('‚úÖ Ruta mejorada con calles reales aplicada');
                
            } catch (error) {
                if (error.name === 'AbortError') {
                    console.log('‚è±Ô∏è OSRM muy lento - manteniendo ruta directa');
                } else {
                    console.log('‚ö†Ô∏è OSRM no disponible:', error.message, '- manteniendo ruta directa');
                }
                // No hacer nada - la ruta directa ya est√° mostrada
            }
        }
    </script>
</body>
</html>
